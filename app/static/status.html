<!-- static/status.html -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å®‰åˆ©æ¼”è¬› AI è½‰éŒ„èˆ‡ç¸½çµ</title>
  <style>
    :root {
      --primary-green: #2d8659;
      --light-green: #4caf50;
      --dark-green: #1b5e3f;
      --accent-green: #81c784;
      --bg-light: #f4f7fa;
      --bg-white: #ffffff;
      --text-dark: #333333;
      --text-light: #666666;
      --border-color: #e0e0e0;
      --download-color: #ff9800;
    }

    html.dark-mode {
      --primary-green: #4caf50;
      --light-green: #66bb6a;
      --dark-green: #2d8659;
      --accent-green: #81c784;
      --bg-light: #1e1e1e;
      --bg-white: #2d2d2d;
      --text-dark: #e0e0e0;
      --text-light: #b0b0b0;
      --border-color: #444444;
      --download-color: #ffb74d;
    }

    * { transition: background-color 0.3s, color 0.3s; }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg-light);
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: var(--bg-white);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    h1 {
      color: var(--primary-green);
      text-align: center;
    }

    h2 {
      color: var(--text-dark);
      border-bottom: 2px solid var(--primary-green);
      padding-bottom: 10px;
    }

    .header-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      position: relative;
    }

    h1 {
      color: var(--primary-green);
      text-align: center;
      margin: 0;
    }

    .dark-mode-toggle {
      background: var(--primary-green);
      color: white;
      border: none;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      min-width: auto;
      width: auto;
      position: absolute;
      right: 0;
      top: 0;
    }

    .dark-mode-toggle:hover {
      background: var(--dark-green);
      transform: scale(1.1);
    }

    .form-group {
      margin: 20px 0;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-dark);
    }

    input[type="text"],
    input[type="file"] {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
      background: var(--bg-white);
      color: var(--text-dark);
    }

    .checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 15px 0;
    }

    button {
      background: var(--primary-green);
      color: white;
      border: none;
      padding: 14px 24px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
      width: 100%;
    }

    button:hover {
      background: var(--dark-green);
    }

    .footer {
      text-align: center;
      margin-top: 30px;
      color: var(--text-light);
      font-size: 14px;
    }

    /* Task list styles */
    .tasks-section {
      margin-top: 40px;
    }

    .task-item {
      background: var(--bg-light);
      border-left: 4px solid var(--primary-green);
      padding: 15px;
      margin: 12px 0;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }

    .task-info {
      flex: 1;
    }

    .task-filename {
      font-weight: 600;
      color: var(--text-dark);
      font-size: 15px;
    }

    .task-metadata {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 4px;
      display: flex;
      gap: 15px;
    }

    .task-timestamp {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .task-size {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .task-duration {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .task-status {
      font-size: 13px;
      color: var(--text-light);
      margin-top: 4px;
    }

    .task-actions {
      display: flex;
      gap: 10px;
    }

    .task-actions a,
    .task-actions button {
      padding: 8px 12px;
      font-size: 13px;
      border-radius: 4px;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-download {
      background: var(--download-color);
      color: white;
    }

    .btn-download:hover {
      background: #f57c00;
    }

    .btn-download:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .hidden-tasks {
      display: none;
    }

    .hidden-tasks.show {
      display: block;
    }

    .toggle-btn {
      background: var(--primary-green);
      color: white;
      padding: 10px 16px;
      margin: 15px 0;
      border-radius: 4px;
      cursor: pointer;
      border: none;
      font-size: 14px;
    }

    .toggle-btn:hover {
      background: var(--dark-green);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--border-color);
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent-green);
      width: 0%;
      transition: width 0.3s;
    }
  </style>
  <script>
function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function formatDuration(seconds) {
  if (seconds === 0) return 'N/A';
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  const secs = seconds % 60;
  
  if (hours > 0) {
    return `${hours}h ${minutes}m ${secs}s`;
  } else if (minutes > 0) {
    return `${minutes}m ${secs}s`;
  } else {
    return `${secs}s`;
  }
}

function formatDate(dateString) {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'å‰›å‰›';
  if (diffMins < 60) return `${diffMins}åˆ†é˜å‰`;
  if (diffHours < 24) return `${diffHours}å°æ™‚å‰`;
  if (diffDays < 7) return `${diffDays}å¤©å‰`;
  
  return date.toLocaleString('zh-TW');
}

function toggleDarkMode() {
  const html = document.documentElement;
  html.classList.toggle('dark-mode');
  localStorage.setItem('darkMode', html.classList.contains('dark-mode'));
}

function pollStatus(taskId, apiKey) {
  if (!taskId || taskId === 'undefined') return;
  
  fetch(`/status/${taskId}?api_key=${apiKey}`)
    .then(response => {
      if (!response.ok) throw new Error(`Status check failed: ${response.status}`);
      return response.json();
    })
    .then(data => {
      const progressEl = document.getElementById(`progress-${taskId}`);
      const downloadBtn = document.getElementById(`download-${taskId}`);
      const progressBar = document.getElementById(`bar-${taskId}`);
      const sizeEl = document.querySelector(`#task-${taskId} .task-size`);
      const durationEl = document.querySelector(`#task-${taskId} .task-duration`);
      
      // âœ… Update metadata if available
      if (data.file_size > 0 && sizeEl) {
        const sizeMB = (data.file_size / 1024 / 1024).toFixed(2);
        sizeEl.innerHTML = `ğŸ’¾ ${sizeMB} MB`;
      }
      
      if (data.audio_duration > 0 && durationEl) {
        const hours = Math.floor(data.audio_duration / 3600);
        const minutes = Math.floor((data.audio_duration % 3600) / 60);
        const secs = data.audio_duration % 60;
        const durationStr = hours > 0 
          ? `${hours}h ${minutes}m` 
          : `${minutes}m ${secs}s`;
        durationEl.innerHTML = `â±ï¸ ${durationStr}`;
      }
      
      if (progressBar) {
        progressBar.style.width = `${data.progress}%`;
      }
      
      progressEl.innerText = `${data.progress}% - ${data.status}`;
      
      if (data.status === 'done') {
        downloadBtn.style.display = 'inline-block';
        downloadBtn.disabled = false;
      } else if (data.status === 'error') {
        progressEl.innerText += ` éŒ¯èª¤: ${data.error}`;
        downloadBtn.disabled = true;
      } else {
        setTimeout(() => pollStatus(taskId, apiKey), 2000);
      }
    })
    .catch(error => {
      console.error('Status poll failed:', error);
      document.getElementById(`progress-${taskId}`).innerText += ` éŒ¯èª¤: ${error.message}`;
    });
}

function startUpload() {
  const form = document.getElementById('upload-form');
  const formData = new FormData(form);
  
  fetch('/transcribe', {
    method: 'POST',
    body: formData,
    headers: { 'Accept': 'application/json' }
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(err => {
        throw new Error(`HTTP error! status: ${response.status}`);
      });
    }
    return response.json();
  })
  .then(data => {
    if (!data.task_id) throw new Error('No task_id returned');
    
    const tasksList = document.getElementById('tasks');
    const now = new Date().toLocaleString('zh-TW');
    const li = document.createElement('li');
    li.id = `task-${data.task_id}`;
    li.className = 'task-item';
    li.innerHTML = `
      <div class="task-info">
        <div class="task-filename">ğŸ”Š ${formData.get('file').name}</div>
        <div class="task-metadata">
          <div class="task-timestamp">â° ${now}</div>
          <div class="task-size">ğŸ’¾ è¨ˆç®—ä¸­...</div>
          <div class="task-duration">â±ï¸ è¨ˆç®—ä¸­...</div>
        </div>
        <div class="task-status">
          é€²åº¦: <span id="progress-${data.task_id}">0% - pending</span>
          <div class="progress-bar">
            <div class="progress-fill" id="bar-${data.task_id}"></div>
          </div>
        </div>
      </div>
      <div class="task-actions">
        <button id="download-${data.task_id}" class="btn-download" style="display:none" 
          onclick="window.location.href='/download/${data.task_id}?api_key=${form.api_key.value}'">
          ä¸‹è¼‰
        </button>
      </div>
    `;
    
    if (tasksList.firstChild) {
      tasksList.insertBefore(li, tasksList.firstChild);
    } else {
      tasksList.appendChild(li);
    }
    
    pollStatus(data.task_id, form.api_key.value);
  })
  .catch(error => {
    console.error('Upload failed:', error);
    alert('è½‰éŒ„å¤±æ•—: ' + error.message);
  });
  
  return false;
}

function toggleHidden() {
  const hidden = document.getElementById('hidden-tasks');
  const btn = document.getElementById('toggle-btn');
  hidden.classList.toggle('show');
  btn.innerText = hidden.classList.contains('show') ? 'éš±è—èˆŠç´€éŒ„' : 'é¡¯ç¤ºæ›´å¤š (10+)';
}

document.addEventListener('DOMContentLoaded', function() {
  // Load dark mode preference
  if (localStorage.getItem('darkMode') === 'true') {
    document.documentElement.classList.add('dark-mode');
  }
  
  // Re-poll any active tasks
  const tasks = document.querySelectorAll('[id^="task-"]');
  const apiKey = document.querySelector('input[name="api_key"]').value;
  
  tasks.forEach(task => {
    const taskId = task.id.replace('task-', '');
    const status = task.querySelector(`#progress-${taskId}`).innerText;
    if (!status.includes('done') && !status.includes('error')) {
      pollStatus(taskId, apiKey);
    }
  });
});
  </script>
</head>
<body>
    <div class="header-controls">
      <h1>ğŸŒ¿ å®‰åˆ©æ¼”è¬› AI è½‰éŒ„ + ç¸½çµ</h1>
      <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="åˆ‡æ›æ·±è‰²æ¨¡å¼">ğŸŒ™</button>
    </div>

    <form id="upload-form" onsubmit="return startUpload();">
      <input type="hidden" name="api_key" value="{{ api_key }}" />
      <div class="form-group">
        <label for="file">ä¸Šå‚³éŸ³æª” (MP3 / M4A / WAV):</label>
        <input type="file" name="file" id="file" accept=".mp3,.m4a,.wav" required />
      </div>
      <div class="checkbox">
        <input type="checkbox" name="summarize" id="summarize" checked />
        <label for="summarize">ç”Ÿæˆ AI ç¸½çµèˆ‡è¬›è€…åˆ†æ</label>
      </div>
      <button type="submit">é–‹å§‹è½‰éŒ„</button>
    </form>

    <div class="tasks-section">
      <h2>ğŸ“‹ ä»»å‹™åˆ—è¡¨</h2>
      
      <!-- Recent 10 tasks -->
      <ul id="tasks" style="list-style: none; padding: 0;">
        {% for task in tasks[:10] %}
          <li id="task-{{ task.id }}" class="task-item">
            <div class="task-info">
              <div class="task-filename">ğŸ“„ {{ task.filename }}</div>
              <div class="task-metadata">
                <div class="task-timestamp">â° {{ task.created_at }}</div>
                <div class="task-size">ğŸ’¾ {{ (task.file_size / 1024 / 1024)|round(2) }} MB</div>
                <div class="task-duration">â±ï¸ 
                  {% if task.audio_duration > 0 %}
                    {% set hours = task.audio_duration // 3600 %}
                    {% set minutes = (task.audio_duration % 3600) // 60 %}
                    {% set secs = task.audio_duration % 60 %}
                    {% if hours > 0 %}{{ hours }}h {{ minutes }}m{% else %}{{ minutes }}m {{ secs }}s{% endif %}
                  {% else %}
                    è¨ˆç®—ä¸­
                  {% endif %}
                </div>
              </div>
              <div class="task-status">
                é€²åº¦: <span id="progress-{{ task.id }}">{{ task.progress }}% - {{ task.status }}{% if task.error %} éŒ¯èª¤: {{ task.error }}{% endif %}</span>
                <div class="progress-bar">
                  <div class="progress-fill" id="bar-{{ task.id }}" style="width: {{ task.progress }}%"></div>
                </div>
              </div>
            </div>
            <div class="task-actions">
              {% if task.status == 'done' %}
                <a href="/download/{{ task.id }}?api_key={{ api_key }}" class="btn-download">ä¸‹è¼‰</a>
              {% else %}
                <button class="btn-download" disabled>ä¸‹è¼‰</button>
              {% endif %}
            </div>
          </li>
          <script>
            {% if task.status != 'done' and task.status != 'error' %}
              pollStatus({{ task.id }}, '{{ api_key }}');
            {% endif %}
          </script>
        {% endfor %}
      </ul>
      
      <!-- Hidden older tasks (10+) -->
      {% if tasks|length > 10 %}
        <button class="toggle-btn" id="toggle-btn" onclick="toggleHidden()">é¡¯ç¤ºæ›´å¤š ({{ tasks|length - 10 }})</button>
        <ul id="hidden-tasks" class="hidden-tasks" style="list-style: none; padding: 0;">
          {% for task in tasks[10:] %}
            <li id="task-{{ task.id }}" class="task-item">
              <div class="task-info">
                <div class="task-filename">ğŸ“„ {{ task.filename }}</div>
                <div class="task-metadata">
                  <div class="task-timestamp">â° {{ task.created_at }}</div>
                  <div class="task-size">ğŸ’¾ {{ (task.file_size / 1024 / 1024)|round(2) }} MB</div>
                  <div class="task-duration">â±ï¸ 
                    {% if task.audio_duration > 0 %}
                      {% set hours = task.audio_duration // 3600 %}
                      {% set minutes = (task.audio_duration % 3600) // 60 %}
                      {% set secs = task.audio_duration % 60 %}
                      {% if hours > 0 %}{{ hours }}h {{ minutes }}m{% else %}{{ minutes }}m {{ secs }}s{% endif %}
                    {% else %}
                      N/A
                    {% endif %}
                  </div>
                </div>
                <div class="task-status">
                  é€²åº¦: <span id="progress-{{ task.id }}">{{ task.progress }}% - {{ task.status }}</span>
                </div>
              </div>
              <div class="task-actions">
                {% if task.status == 'done' %}
                  <a href="/download/{{ task.id }}?api_key={{ api_key }}" class="btn-download">ä¸‹è¼‰</a>
                {% else %}
                  <button class="btn-download" disabled>ä¸‹è¼‰</button>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>

    <div class="footer">
      <p>ğŸ” é‡‘é‘°ä¿è­· | åƒ…é™æˆæ¬Šç”¨æˆ¶</p>
    </div>
  </div>
</body>
</html>